#!/usr/bin/env python3
import sqlite3
from pathlib import Path
import pandas as pd
from datetime import datetime

# --------- การตั้งค่า ----------
DB_PATH = Path("furniture.db")

# ---------- ข้อมูลเฟอร์นิเจอร์ ----------
def create_furniture_data():
    """สร้างข้อมูลเฟอร์นิเจอร์เป็นรายการของดิกชันนารี"""
    furniture_products = [
        {
            "รหัสสินค้า": "FUR-001",
            "ชื่อสินค้า": "โต๊ะทานอาหารไม้โอ๊คสมัยใหม่",
            "หมวดหมู่": "ห้องทานอาหาร",
            "วัสดุ": "ไม้โอ๊คแท้",
            "ความยาว_นิ้ว": 72,
            "ความกว้าง_นิ้ว": 36,
            "ความสูง_นิ้ว": 30,
            "สี": "โอ๊คธรรมชาติ",
            "ราคา": 899.99,
            "น้ำหนัก_ปอนด์": 85,
            "ต้องประกอบ": True,
            "การรับประกัน_ปี": 5,
            "จำนวนสต็อก": 12,
            "สถานะสต็อก": "มีสินค้า"
        },
        {
            "รหัสสินค้า": "FUR-002",
            "ชื่อสินค้า": "โซฟาเซ็คชั่นนอลผ้ากำมะหยี่หรู",
            "หมวดหมู่": "ห้องนั่งเล่น",
            "วัสดุ": "ผ้ากำมะหยี่, โครงไม้แข็ง",
            "ความยาว_นิ้ว": 108,
            "ความกว้าง_นิ้ว": 75,
            "ความสูง_นิ้ว": 32,
            "สี": "เขียวมรกต",
            "ราคา": 1599.99,
            "น้ำหนัก_ปอนด์": 150,
            "ต้องประกอบ": False,
            "การรับประกัน_ปี": 3,
            "จำนวนสต็อก": 5,
            "สถานะสต็อก": "มีสินค้า"
        },
        {
            "รหัสสินค้า": "FUR-003",
            "ชื่อสินค้า": "ชั้นหนังสือโลหะสไตล์อุตสาหกรรม",
            "หมวดหมู่": "จัดเก็บ",
            "วัสดุ": "โครงเหล็ก, ชั้นไม้รีไซเคิล",
            "ความยาว_นิ้ว": 36,
            "ความกว้าง_นิ้ว": 12,
            "ความสูง_นิ้ว": 72,
            "สี": "ดำ/น้ำตาลเก่า",
            "ราคา": 449.99,
            "น้ำหนัก_ปอนด์": 65,
            "ต้องประกอบ": True,
            "การรับประกัน_ปี": 2,
            "จำนวนสต็อก": 3,
            "สถานะสต็อก": "สต็อกน้อย"
        },
        {
            "รหัสสินค้า": "FUR-004",
            "ชื่อสินค้า": "เตียงแพลตฟอร์มขนาดควีน",
            "หมวดหมู่": "ห้องนอน",
            "วัสดุ": "ไม้วิศวกรรม, หัวเตียงผ้า",
            "ความยาว_นิ้ว": 83,
            "ความกว้าง_นิ้ว": 63,
            "ความสูง_นิ้ว": 42,
            "สี": "เทาถ่าน",
            "ราคา": 679.99,
            "น้ำหนัก_ปอนด์": 120,
            "ต้องประกอบ": True,
            "การรับประกัน_ปี": 3,
            "จำนวนสต็อก": 8,
            "สถานะสต็อก": "มีสินค้า"
        },
        {
            "รหัสสินค้า": "FUR-005",
            "ชื่อสินค้า": "เก้าอี้สำนักงานเพื่อสุขภาพ",
            "หมวดหมู่": "สำนักงาน",
            "วัสดุ": "พนักพิงตาข่าย, เบาะผ้า",
            "ความยาว_นิ้ว": 26,
            "ความกว้าง_นิ้ว": 26,
            "ความสูง_นิ้ว": 42,
            "สี": "ดำ/เทา",
            "ราคา": 329.99,
            "น้ำหนัก_ปอนด์": 35,
            "ต้องประกอบ": True,
            "การรับประกัน_ปี": 2,
            "จำนวนสต็อก": 15,
            "สถานะสต็อก": "มีสินค้า"
        },
        {
            "รหัสสินค้า": "FUR-006",
            "ชื่อสินค้า": "โต๊ะกาแฟไม้สน rustic",
            "หมวดหมู่": "ห้องนั่งเล่น",
            "วัสดุ": "ไม้สนรีไซเคิล",
            "ความยาว_นิ้ว": 48,
            "ความกว้าง_นิ้ว": 24,
            "ความสูง_นิ้ว": 18,
            "สี": "ไม้สนเก่า",
            "ราคา": 399.99,
            "น้ำหนัก_ปอนด์": 45,
            "ต้องประกอบ": False,
            "การรับประกัน_ปี": 3,
            "จำนวนสต็อก": 7,
            "สถานะสต็อก": "มีสินค้า"
        },
        {
            "รหัสสินค้า": "FUR-007",
            "ชื่อสินค้า": "ตู้ข้างเตียงสมัยใหม่",
            "หมวดหมู่": "ห้องนอน",
            "วัสดุ": "MDF เคลือบเงาสูง",
            "ความยาว_นิ้ว": 24,
            "ความกว้าง_นิ้ว": 16,
            "ความสูง_นิ้ว": 24,
            "สี": "ขาว",
            "ราคา": 189.99,
            "น้ำหนัก_ปอนด์": 25,
            "ต้องประกอบ": True,
            "การรับประกัน_ปี": 1,
            "จำนวนสต็อก": 20,
            "สถานะสต็อก": "มีสินค้า"
        },
        {
            "รหัสสินค้า": "FUR-008",
            "ชื่อสินค้า": "เก้าอี้หนังปรับเอนได้",
            "หมวดหมู่": "ห้องนั่งเล่น",
            "วัสดุ": "หนังแท้, กลไกเหล็ก",
            "ความยาว_นิ้ว": 32,
            "ความกว้าง_นิ้ว": 35,
            "ความสูง_นิ้ว": 40,
            "สี": "หนังน้ำตาล",
            "ราคา": 1199.99,
            "น้ำหนัก_ปอนด์": 95,
            "ต้องประกอบ": False,
            "การรับประกัน_ปี": 5,
            "จำนวนสต็อก": 4,
            "สถานะสต็อก": "มีสินค้า"
        },
        {
            "รหัสสินค้า": "FUR-009",
            "ชื่อสินค้า": "โต๊ะคอมพิวเตอร์หน้ากระจก",
            "หมวดหมู่": "สำนักงาน",
            "วัสดุ": "กระจกเทมเปอร์, ขาโครเมี่ยม",
            "ความยาว_นิ้ว": 55,
            "ความกว้าง_นิ้ว": 24,
            "ความสูง_นิ้ว": 30,
            "สี": "ใส/โครเมี่ยม",
            "ราคา": 299.99,
            "น้ำหนัก_ปอนด์": 55,
            "ต้องประกอบ": True,
            "การรับประกัน_ปี": 2,
            "จำนวนสต็อก": 9,
            "สถานะสต็อก": "มีสินค้า"
        },
        {
            "รหัสสินค้า": "FUR-010",
            "ชื่อสินค้า": "เก้าอี้ทานอาหารหุ้มผ้า (ชุด 4 ตัว)",
            "หมวดหมู่": "ห้องทานอาหาร",
            "วัสดุ": "ผ้าลินิน, ขาไม้โอ๊ค",
            "ความยาว_นิ้ว": 18,
            "ความกว้าง_นิ้ว": 22,
            "ความสูง_นิ้ว": 32,
            "สี": "เทาอ่อน",
            "ราคา": 359.99,
            "น้ำหนัก_ปอนด์": 60,
            "ต้องประกอบ": False,
            "การรับประกัน_ปี": 2,
            "จำนวนสต็อก": 6,
            "สถานะสต็อก": "มีสินค้า"
        },
        {
            "รหัสสินค้า": "FUR-011",
            "ชื่อสินค้า": "ตู้ลิ้นชักสไตล์ mid-century",
            "หมวดหมู่": "ห้องนอน",
            "วัสดุ": "วอลนัทผิวไม้, ฮาร์ดแวร์ทองเหลือง",
            "ความยาว_นิ้ว": 60,
            "ความกว้าง_นิ้ว": 18,
            "ความสูง_นิ้ว": 32,
            "สี": "วอลนัท",
            "ราคา": 849.99,
            "น้ำหนัก_ปอนด์": 110,
            "ต้องประกอบ": True,
            "การรับประกัน_ปี": 3,
            "จำนวนสต็อก": 2,
            "สถานะสต็อก": "สต็อกน้อย"
        },
        {
            "รหัสสินค้า": "FUR-012",
            "ชื่อสินค้า": "ชั้นแขวนผนัง (ชุด 3 ชิ้น)",
            "หมวดหมู่": "จัดเก็บ",
            "วัสดุ": "ไม้สนแท้",
            "ความยาว_นิ้ว": 24,
            "ความกว้าง_นิ้ว": 6,
            "ความสูง_นิ้ว": 2,
            "สี": "ขาว",
            "ราคา": 79.99,
            "น้ำหนัก_ปอนด์": 9,
            "ต้องประกอบ": True,
            "การรับประกัน_ปี": 1,
            "จำนวนสต็อก": 25,
            "สถานะสต็อก": "มีสินค้า"
        },
        {
            "รหัสสินค้า": "FUR-013",
            "ชื่อสินค้า": "โต๊ะทานอาหารกลมฐานเสา",
            "หมวดหมู่": "ห้องทานอาหาร",
            "วัสดุ": "หน้าหินอ่อน, ฐานเหล็กหล่อ",
            "ความยาว_นิ้ว": 42,
            "ความกว้าง_นิ้ว": 42,
            "ความสูง_นิ้ว": 30,
            "สี": "หินอ่อนขาว/ฐานดำ",
            "ราคา": 1299.99,
            "น้ำหนัก_ปอนด์": 140,
            "ต้องประกอบ": True,
            "การรับประกัน_ปี": 3,
            "จำนวนสต็อก": 3,
            "สถานะสต็อก": "มีสินค้า"
        },
        {
            "รหัสสินค้า": "FUR-014",
            "ชื่อสินค้า": "เก้าอี้ยาวมีที่เก็บของ",
            "หมวดหมู่": "ห้องนั่งเล่น",
            "วัสดุ": "หนังเทียม, โครงไม้",
            "ความยาว_นิ้ว": 36,
            "ความกว้าง_นิ้ว": 16,
            "ความสูง_นิ้ว": 18,
            "สี": "น้ำตาลเข้ม",
            "ราคา": 149.99,
            "น้ำหนัก_ปอนด์": 22,
            "ต้องประกอบ": False,
            "การรับประกัน_ปี": 1,
            "จำนวนสต็อก": 14,
            "สถานะสต็อก": "มีสินค้า"
        },
        {
            "รหัสสินค้า": "FUR-015",
            "ชื่อสินค้า": "โต๊ะปรับระดับได้",
            "หมวดหมู่": "สำนักงาน",
            "วัสดุ": "หน้าไผ่, โครงเหล็ก",
            "ความยาว_นิ้ว": 48,
            "ความกว้าง_นิ้ว": 24,
            "ความสูง_นิ้ว": 37,
            "สี": "ไผ่ธรรมชาติ/ดำ",
            "ราคา": 599.99,
            "น้ำหนัก_ปอนด์": 75,
            "ต้องประกอบ": True,
            "การรับประกัน_ปี": 3,
            "จำนวนสต็อก": 6,
            "สถานะสต็อก": "มีสินค้า"
        }
    ]
    
    return pd.DataFrame(furniture_products)

# ---------- สร้างโครงสร้างฐานข้อมูล ----------
def create_schema(conn: sqlite3.Connection):
    """สร้างโครงสร้างฐานข้อมูลเฟอร์นิเจอร์"""
    cur = conn.cursor()

    cur.execute("""
    CREATE TABLE IF NOT EXISTS สินค้า (
      รหัสสินค้า TEXT PRIMARY KEY,
      ชื่อสินค้า TEXT NOT NULL,
      หมวดหมู่ TEXT NOT NULL,
      วัสดุ TEXT,
      ความยาว_นิ้ว INTEGER,
      ความกว้าง_นิ้ว INTEGER,
      ความสูง_นิ้ว INTEGER,
      สี TEXT,
      ราคา REAL NOT NULL,
      น้ำหนัก_ปอนด์ REAL,
      ต้องประกอบ BOOLEAN,
      การรับประกัน_ปี INTEGER,
      จำนวนสต็อก INTEGER NOT NULL,
      สถานะสต็อก TEXT,
      วันที่สร้าง DATE DEFAULT CURRENT_DATE,
      อัปเดตล่าสุด TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );
    """)

    # สร้างตารางหมวดหมู่เพื่อการจัดระเบียบ
    cur.execute("""
    CREATE TABLE IF NOT EXISTS หมวดหมู่ (
      ชื่อหมวดหมู่ TEXT PRIMARY KEY,
      คำอธิบาย TEXT,
      วันที่สร้าง DATE DEFAULT CURRENT_DATE
    );
    """)

    # สร้าง index เพื่อประสิทธิภาพในการค้นหา
    cur.execute("CREATE INDEX IF NOT EXISTS idx_สินค้า_หมวดหมู่ ON สินค้า(หมวดหมู่);")
    cur.execute("CREATE INDEX IF NOT EXISTS idx_สินค้า_ราคา ON สินค้า(ราคา);")
    cur.execute("CREATE INDEX IF NOT EXISTS idx_สินค้า_สถานะสต็อก ON สินค้า(สถานะสต็อก);")
    cur.execute("CREATE INDEX IF NOT EXISTS idx_สินค้า_การรับประกัน ON สินค้า(การรับประกัน_ปี);")
    
    conn.commit()

def populate_categories(conn: sqlite3.Connection):
    """เติมข้อมูลหมวดหมู่เฟอร์นิเจอร์"""
    categories_data = [
        ("ห้องนั่งเล่น", "เฟอร์นิเจอร์สำหรับพื้นที่นั่งเล่น รวมถึงโซฟา เก้าอี้ และโต๊ะ"),
        ("ห้องนอน", "เฟอร์นิเจอร์สำหรับห้องนอน รวมถึงเตียง ตู้ลิ้นชัก และตู้ข้างเตียง"),
        ("ห้องทานอาหาร", "เฟอร์นิเจอร์สำหรับพื้นที่ทานอาหาร รวมถึงโต๊ะอาหารและเก้าอี้"),
        ("สำนักงาน", "เฟอร์นิเจอร์สำหรับพื้นที่ทำงาน รวมถึงโต๊ะทำงานและเก้าอี้สำนักงาน"),
        ("จัดเก็บ", "โซลูชั่นการจัดเก็บ รวมถึงชั้นวางและตู้หนังสือ")
    ]
    
    cur = conn.cursor()
    cur.executemany("""
        INSERT OR IGNORE INTO หมวดหมู่ (ชื่อหมวดหมู่, คำอธิบาย)
        VALUES (?, ?)
    """, categories_data)
    conn.commit()

# ---------- การวิเคราะห์ข้อมูล ----------
def run_analysis_queries(conn: sqlite3.Connection):
    """รันคำสั่งวิเคราะห์ตัวอย่างกับข้อมูลเฟอร์นิเจอร์"""
    cur = conn.cursor()
    
    print("\n" + "="*60)
    print("การวิเคราะห์ฐานข้อมูลเฟอร์นิเจอร์")
    print("="*60)
    
    # จำนวนสินค้าแยกตามหมวดหมู่
    print("\n1. สินค้าแยกตามหมวดหมู่:")
    cur.execute("""
        SELECT หมวดหมู่, COUNT(*) as จำนวนสินค้า, 
               ROUND(AVG(ราคา), 2) as ราคาเฉลี่ย,
               SUM(จำนวนสต็อก) as สต็อกรวม
        FROM สินค้า 
        GROUP BY หมวดหมู่ 
        ORDER BY จำนวนสินค้า DESC
    """)
    for row in cur.fetchall():
        print(f"   {row[0]}: {row[1]} ชิ้น, ราคาเฉลี่ย: ${row[2]:,}, สต็อก: {row[3]} ชิ้น")
    
    # การวิเคราะห์ราคา
    print("\n2. การวิเคราะห์ราคา:")
    cur.execute("""
        SELECT 
            COUNT(*) as จำนวนสินค้าทั้งหมด,
            ROUND(MIN(ราคา), 2) as ราคาต่ำสุด,
            ROUND(MAX(ราคา), 2) as ราคาสูงสุด,
            ROUND(AVG(ราคา), 2) as ราคาเฉลี่ย,
            ROUND(SUM(ราคา * จำนวนสต็อก), 2) as มูลค่าสต็อกรวม
        FROM สินค้า
    """)
    result = cur.fetchone()
    print(f"   จำนวนสินค้าทั้งหมด: {result[0]}")
    print(f"   ช่วงราคา: ${result[1]:,} - ${result[2]:,}")
    print(f"   ราคาเฉลี่ย: ${result[3]:,}")
    print(f"   มูลค่าสต็อกรวม: ${result[4]:,}")
    
    # การวิเคราะห์การประกอบและการรับประกัน
    print("\n3. การวิเคราะห์การประกอบและการรับประกัน:")
    cur.execute("""
        SELECT 
            CASE WHEN ต้องประกอบ = 1 THEN 'ต้องประกอบ' ELSE 'ไม่ต้องประกอบ' END as การประกอบ,
            COUNT(*) as จำนวน,
            ROUND(AVG(ราคา), 2) as ราคาเฉลี่ย
        FROM สินค้า 
        GROUP BY ต้องประกอบ
    """)
    for row in cur.fetchall():
        print(f"   {row[0]}: {row[1]} ชิ้น, ราคาเฉลี่ย: ${row[2]:,}")
    
    cur.execute("""
        SELECT การรับประกัน_ปี, COUNT(*) as จำนวน
        FROM สินค้า 
        GROUP BY การรับประกัน_ปี
        ORDER BY การรับประกัน_ปี
    """)
    print("\n   การกระจายการรับประกัน:")
    for row in cur.fetchall():
        print(f"   {row[0]} ปี: {row[1]} ชิ้น")
    
    # สถานะสต็อก
    print("\n4. สถานะสต็อก:")
    cur.execute("""
        SELECT สถานะสต็อก, COUNT(*) as จำนวน, SUM(จำนวนสต็อก) as ชิ้นรวม
        FROM สินค้า 
        GROUP BY สถานะสต็อก
    """)
    for row in cur.fetchall():
        print(f"   {row[0]}: {row[1]} รายการ, {row[2]} ชิ้น")
    
    # 5 สินค้าที่แพงที่สุด
    print("\n5. 5 สินค้าที่แพงที่สุด:")
    cur.execute("""
        SELECT ชื่อสินค้า, หมวดหมู่, ราคา, จำนวนสต็อก
        FROM สินค้า 
        ORDER BY ราคา DESC 
        LIMIT 5
    """)
    for row in cur.fetchall():
        print(f"   ${row[2]:,} - {row[0]} ({row[1]}) - สต็อก: {row[3]}")
    
    # สินค้าที่ต้องเติมสต็อก (น้อยกว่า 5 ชิ้น)
    print("\n6. สินค้าที่ต้องเติมสต็อก (น้อยกว่า 5 ชิ้น):")
    cur.execute("""
        SELECT ชื่อสินค้า, หมวดหมู่, จำนวนสต็อก, ราคา
        FROM สินค้า 
        WHERE จำนวนสต็อก < 5
        ORDER BY จำนวนสต็อก ASC
    """)
    for row in cur.fetchall():
        print(f"   {row[2]} ชิ้น - {row[0]} ({row[1]}) - ${row[3]:,}")

# ---------- ฟังก์ชันหลัก ----------
def main():
    print("กำลังสร้างฐานข้อมูลเฟอร์นิเจอร์...")
    
    # สร้างข้อมูลเฟอร์นิเจอร์
    furniture_df = create_furniture_data()
    print(f"สร้างข้อมูลเฟอร์นิเจอร์ {len(furniture_df)} รายการ")
    
    # สร้างฐานข้อมูลใหม่
    if DB_PATH.exists():
        DB_PATH.unlink()
    
    conn = sqlite3.connect(DB_PATH)
    
    # สร้างโครงสร้าง
    create_schema(conn)
    print("สร้างโครงสร้างฐานข้อมูลเรียบร้อย")
    
    # เติมข้อมูลหมวดหมู่
    populate_categories(conn)
    print("เติมข้อมูลหมวดหมู่เรียบร้อย")
    
    # โหลดข้อมูลเฟอร์นิเจอร์เข้า SQLite
    furniture_df.to_sql("สินค้า", conn, if_exists="append", index=False)
    print(f"โหลดข้อมูล {len(furniture_df)} รายการเข้าฐานข้อมูลเรียบร้อย")
    
    # รันการวิเคราะห์ข้อมูล
    run_analysis_queries(conn)
    
    conn.close()
    print(f"\nสร้างฐานข้อมูลสำเร็จ: {DB_PATH.resolve()}")
    print(f"ขนาดฐานข้อมูล: {DB_PATH.stat().st_size / 1024:.1f} KB")

if __name__ == "__main__":
    main()